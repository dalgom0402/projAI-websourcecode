from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import pickle
import numpy as np

# --- 1. Load the Model ---
# This path must match the filename created in training_and_evaluation.py
MODEL_PATH = 'best_diabetes_model.pkl'
model_pipeline = None

try:
    with open(MODEL_PATH, 'rb') as file:
        model_pipeline = pickle.load(file)
    print("Best Model loaded successfully.")
    
    # Optional check: Determine which model was saved inside the pipeline
    model_name = model_pipeline.steps[-1][0].upper().replace('_', ' ')
    print(f"Loaded Model Type: {model_name}")

except FileNotFoundError:
    print(f"Error: Model file not found at {MODEL_PATH}.")
    print("Please ensure you have run 'training_and_evaluation.py' successfully.")
except Exception as e:
    print(f"Error loading the model file: {e}")
    model_pipeline = None


# --- 2. Setup FastAPI App ---
app = FastAPI(title="Diabetes Risk Predictor API")

# Add CORS middleware to allow the front-end application to send requests
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Allows all origins for development/local testing
    allow_methods=["POST", "GET"],
    allow_headers=["*"],
)

# --- 3. Define the Input Data Structure ---
# This structure must match the data sent from your front-end application.
class PredictionFeatures(BaseModel):
    pregnancies: float
    glucose: float
    blood_pressure: float
    skin_thickness: float
    insulin: float
    bmi: float
    diabetes_pedigree_function: float
    age: float

# --- 4. Define the API Endpoints ---

@app.get("/")
def home():
    """Simple health check endpoint."""
    return {"status": "ok", "message": "Diabetes Prediction API is running."}

@app.post("/predict")
def predict_diabetes(data: PredictionFeatures):
    """
    Endpoint to receive patient features and return a diabetes risk prediction.
    """
    if model_pipeline is None:
        return {"error": "Model not loaded. Cannot predict."}, 500

    try:
        # Convert incoming data (Pydantic model) into a list for NumPy
        input_data = [
            data.pregnancies, data.glucose, data.blood_pressure, 
            data.skin_thickness, data.insulin, data.bmi, 
            data.diabetes_pedigree_function, data.age
        ]
        
        # Reshape data for the pipeline: [1, 8]
        features = np.array([input_data])
        
        # Predict the outcome (0 or 1) using the loaded pipeline
        prediction = model_pipeline.predict(features)[0].item()
        
        # Predict the probability for confidence score
        probabilities = model_pipeline.predict_proba(features)[0]
        # Get the probability for the predicted class
        confidence = probabilities[prediction].item() 
        
        # Format the result
        result = {
            "prediction_code": prediction,
            "result_message": "Diabetic (High Risk)" if prediction == 1 else "Non-Diabetic",
            "confidence_score": round(confidence, 4)
        }
        
        return result
        
    except Exception as e:
        print(f"Prediction error: {e}")
        return {"error": f"Prediction failed due to internal server error."}, 500
